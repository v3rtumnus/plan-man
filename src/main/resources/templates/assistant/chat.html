<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:replace="~{fragments/header :: header-css}"/>
</head>
<body>

<div th:replace="~{fragments/header :: header}"/>
<div th:replace="~{fragments/sidebar :: sidebar}"/>

<main id="main" class="main">

    <div class="pagetitle">
        <h1>KI-Assistent</h1>
    </div>

    <div class="row g-3">

        <!-- MCP server info (left column) -->
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">MCP-Server</h5>
                    <p class="text-muted" style="font-size: 0.8rem;">Hover f&uuml;r Werkzeugdetails</p>

                    <div th:each="entry : ${mcpServers}" class="mb-2 position-relative mcp-server-item">
                        <div class="border rounded p-2" style="cursor: pointer;">
                            <div class="fw-semibold small" th:text="${entry.key}">Servername</div>
                            <div class="text-muted" style="font-size: 0.75rem;"
                                 th:text="${entry.value.size()} + ' Werkzeuge verf&uuml;gbar'">0 Werkzeuge</div>
                        </div>
                        <div class="mcp-tooltip border rounded shadow p-2 bg-white"
                             style="display:none; position:absolute; left:100%; top:0; width:280px; max-height:300px; overflow-y:auto; z-index:1000;">
                            <div class="fw-semibold small text-uppercase text-muted border-bottom pb-1 mb-2"
                                 th:text="'Werkzeuge von ' + ${entry.key}">Werkzeuge</div>
                            <div th:each="tool : ${entry.value}" class="border-bottom py-1">
                                <div class="fw-semibold small" th:text="${tool.name}">Werkzeugname</div>
                                <div class="text-muted" style="font-size: 0.7rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;"
                                     th:if="${tool.description != null and !tool.description.isEmpty()}"
                                     th:text="${tool.description}">Beschreibung</div>
                            </div>
                            <div th:if="${entry.value.isEmpty()}" class="text-muted small">Keine Werkzeuge verf&uuml;gbar</div>
                        </div>
                    </div>
                    <div th:if="${mcpServers.isEmpty()}" class="text-muted small">Keine MCP-Server konfiguriert</div>
                </div>
            </div>
        </div>

        <!-- Chat area (center column) -->
        <div class="col-md-6">
            <div class="card" style="height: 75vh; display: flex; flex-direction: column;">
                <div class="card-body p-3" id="messages" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;">
                    <!-- Empty state -->
                    <div id="empty-state" class="d-flex flex-column align-items-center justify-content-center h-100 text-center text-muted">
                        <i class="bi bi-robot" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">Willkommen beim KI-Assistenten</h5>
                        <p class="small">Ich kann bei Smart-Home-Steuerung, Finanzverwaltung und allgemeinen Fragen helfen.</p>
                        <div class="d-flex flex-wrap gap-2 mt-2 justify-content-center">
                            <button class="btn btn-outline-secondary btn-sm" onclick="sendSuggestion('Schalte das Licht im Wohnzimmer ein')">Wohnzimmer-Licht einschalten</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="sendSuggestion('Zeige meine Budgetu&#776;bersicht')">Budget&uuml;bersicht anzeigen</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="sendSuggestion('Wie ist das Wetter heute?')">Wetter abfragen</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="sendSuggestion('Erkl&auml;re Quantencomputing')">Quantencomputing erkl&auml;ren</button>
                        </div>
                    </div>
                </div>
                <div class="card-footer p-2">
                    <div id="loading" class="text-muted small mb-1" style="display: none;">
                        <span class="spinner-border spinner-border-sm me-1"></span>Wird verarbeitet...
                    </div>
                    <div class="d-flex gap-2 align-items-end">
                        <textarea id="message-input" class="form-control" rows="1"
                                  placeholder="Stelle mir eine Frage..."
                                  style="resize: none; max-height: 120px; overflow-y: auto;"></textarea>
                        <div class="d-flex flex-column align-items-center gap-1">
                            <div class="form-check form-switch mb-0" title="Streaming aktivieren">
                                <input class="form-check-input" type="checkbox" id="streaming-toggle" checked>
                            </div>
                            <button id="send-button" class="btn btn-primary btn-sm px-3" onclick="sendMessage()">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-muted mt-1" style="font-size: 0.7rem;">Enter zum Senden &middot; Shift+Enter f&uuml;r neue Zeile &middot; Streaming: <span id="streaming-label">Ein</span></div>
                </div>
            </div>
        </div>

        <!-- Metrics panel (right column) -->
        <div class="col-md-3">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Live-Metriken</h5>

                    <div class="border rounded p-2 mb-2">
                        <div class="text-uppercase text-muted" style="font-size: 0.7rem;">Anfragen gesamt</div>
                        <div class="fw-bold fs-4" id="total-queries">0</div>
                        <div class="text-muted" style="font-size: 0.75rem;">Seit Seitenaufruf</div>
                    </div>

                    <div class="border rounded p-2 mb-2">
                        <div class="text-uppercase text-muted" style="font-size: 0.7rem;">Durchschn. Antwortzeit</div>
                        <div class="fw-bold fs-4" id="avg-response-time">--</div>
                        <div class="text-muted" style="font-size: 0.75rem;">Millisekunden</div>
                    </div>

                    <div class="border rounded p-2 mb-2">
                        <div class="text-uppercase text-muted mb-1" style="font-size: 0.7rem;">MCP-Werkzeugnutzung</div>
                        <div id="mcp-usage">
                            <div class="text-muted small">Noch keine Werkzeuge verwendet</div>
                        </div>
                    </div>

                    <div class="border rounded p-2">
                        <div class="text-uppercase text-muted mb-1" style="font-size: 0.7rem;">Datenschutz</div>
                        <div class="text-muted small">Personenbezogene Daten werden vor dem Senden an die Cloud-KI automatisch anonymisiert.</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</main>

<div th:replace="~{fragments/footer :: footer-js}"/>

<script>
    let conversationId = null;
    let metrics = {
        totalQueries: 0,
        totalResponseTime: 0,
        mcpToolUsage: {}
    };

    // Auto-resize textarea
    const messageInput = document.getElementById('message-input');
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Send on Enter (Shift+Enter for new line)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Streaming toggle label
    document.getElementById('streaming-toggle').addEventListener('change', function() {
        document.getElementById('streaming-label').textContent = this.checked ? 'Ein' : 'Aus';
    });

    // MCP server tooltips
    document.querySelectorAll('.mcp-server-item').forEach(item => {
        const tooltip = item.querySelector('.mcp-tooltip');
        if (!tooltip) return;
        let hideTimeout = null;

        item.addEventListener('mouseenter', () => {
            if (hideTimeout) { clearTimeout(hideTimeout); hideTimeout = null; }
            tooltip.style.display = 'block';
        });
        item.addEventListener('mouseleave', () => {
            hideTimeout = setTimeout(() => { tooltip.style.display = 'none'; }, 150);
        });
        tooltip.addEventListener('mouseenter', () => {
            if (hideTimeout) { clearTimeout(hideTimeout); hideTimeout = null; }
        });
        tooltip.addEventListener('mouseleave', () => {
            hideTimeout = setTimeout(() => { tooltip.style.display = 'none'; }, 150);
        });
    });

    function sendSuggestion(text) {
        messageInput.value = text;
        sendMessage();
    }

    async function sendMessage() {
        const message = messageInput.value.trim();
        const useStreaming = document.getElementById('streaming-toggle').checked;
        if (!message) return;

        messageInput.value = '';
        messageInput.style.height = 'auto';
        messageInput.disabled = true;
        document.getElementById('send-button').disabled = true;
        document.getElementById('loading').style.display = 'block';

        const emptyState = document.getElementById('empty-state');
        if (emptyState) emptyState.remove();

        addMessage('user', message);

        const startTime = Date.now();
        try {
            if (useStreaming) {
                await sendMessageStreaming(message, startTime);
            } else {
                await sendMessageNonStreaming(message, startTime);
            }
        } catch (error) {
            console.error('Fehler:', error);
            addMessage('assistant', 'Entschuldigung, ein Fehler ist aufgetreten: ' + error.message);
        } finally {
            messageInput.disabled = false;
            document.getElementById('send-button').disabled = false;
            document.getElementById('loading').style.display = 'none';
            messageInput.focus();
        }
    }

    async function sendMessageStreaming(message, startTime) {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'd-flex gap-2';
        messageDiv.innerHTML = `
            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center flex-shrink-0" style="width:36px;height:36px;font-size:0.8rem;font-weight:600;">KI</div>
            <div>
                <div class="bg-light border rounded p-2" id="streaming-content" style="white-space: pre-wrap; word-break: break-word;"></div>
                <div class="d-flex flex-wrap gap-1 mt-1" id="streaming-metrics"></div>
            </div>`;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        const contentDiv = document.getElementById('streaming-content');
        let fullResponse = '';
        let streamMetadata = null;

        const response = await fetch('/api/assistant/chat/stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message, conversationId: conversationId })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const events = buffer.split('\n\n');
            buffer = events.pop() || '';

            for (const eventBlock of events) {
                if (!eventBlock.trim()) continue;
                const lines = eventBlock.split('\n');
                let eventType = null;
                let eventData = null;
                for (const line of lines) {
                    if (line.startsWith('event:')) eventType = line.slice(6).trim();
                    else if (line.startsWith('data:')) eventData = line.slice(5);
                }
                if (eventType === 'done' && eventData) {
                    try {
                        streamMetadata = JSON.parse(eventData);
                        if (streamMetadata.conversationId) conversationId = streamMetadata.conversationId;
                    } catch (e) { console.error('Failed to parse stream metadata:', e); }
                } else if (eventData !== null) {
                    fullResponse += eventData;
                    contentDiv.textContent = fullResponse;
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            }
        }

        const responseTime = Date.now() - startTime;
        const metricsDiv = document.getElementById('streaming-metrics');
        metricsDiv.innerHTML = `<span class="badge bg-secondary">${responseTime}ms</span><span class="badge bg-success">Gestreamt</span>`;
        if (streamMetadata && streamMetadata.toolsUsed && streamMetadata.toolsUsed.length > 0) {
            const toolNames = streamMetadata.toolsUsed.map(t => t.split(':')[1]).join(', ');
            metricsDiv.innerHTML += `<span class="badge bg-primary">Tools: ${escapeHtml(toolNames)}</span>`;
            streamMetadata.toolsUsed.forEach(tool => {
                metrics.mcpToolUsage[tool] = (metrics.mcpToolUsage[tool] || 0) + 1;
            });
            updateMcpUsage();
        }

        contentDiv.removeAttribute('id');
        metricsDiv.removeAttribute('id');

        metrics.totalQueries++;
        metrics.totalResponseTime += responseTime;
        updateQueryMetrics();
    }

    async function sendMessageNonStreaming(message, startTime) {
        const response = await fetch('/api/assistant/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message, conversationId: conversationId })
        });
        const data = await response.json();
        conversationId = data.conversationId;
        const responseTime = Date.now() - startTime;
        updateMetrics(data, responseTime);
        addMessage('assistant', data.response, data);
    }

    function updateMetrics(data, responseTime) {
        metrics.totalQueries++;
        metrics.totalResponseTime += responseTime;
        updateQueryMetrics();
        if (data.toolsUsed && data.toolsUsed.length > 0) {
            data.toolsUsed.forEach(tool => {
                metrics.mcpToolUsage[tool] = (metrics.mcpToolUsage[tool] || 0) + 1;
            });
            updateMcpUsage();
        }
    }

    function updateQueryMetrics() {
        document.getElementById('total-queries').textContent = metrics.totalQueries;
        const avgTime = Math.round(metrics.totalResponseTime / metrics.totalQueries);
        document.getElementById('avg-response-time').textContent = avgTime + 'ms';
    }

    function updateMcpUsage() {
        const usageDiv = document.getElementById('mcp-usage');
        if (Object.keys(metrics.mcpToolUsage).length === 0) {
            usageDiv.innerHTML = '<div class="text-muted small">Noch keine Werkzeuge verwendet</div>';
            return;
        }
        const sorted = Object.entries(metrics.mcpToolUsage).sort((a, b) => b[1] - a[1]).slice(0, 5);
        usageDiv.innerHTML = sorted.map(([tool, count]) => {
            const [server, toolName] = tool.split(':');
            return `<div class="d-flex justify-content-between border-bottom py-1">
                <span class="small">${escapeHtml(toolName)} <span class="text-muted">@${escapeHtml(server)}</span></span>
                <span class="small fw-semibold">${count}&times;</span>
            </div>`;
        }).join('');
    }

    function addMessage(role, content, data) {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');

        if (role === 'user') {
            messageDiv.className = 'd-flex gap-2 justify-content-end';
            messageDiv.innerHTML = `
                <div>
                    <div class="bg-primary text-white rounded p-2" style="white-space: pre-wrap; word-break: break-word;">${escapeHtml(content)}</div>
                </div>
                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center flex-shrink-0" style="width:36px;height:36px;font-size:0.8rem;font-weight:600;">Du</div>`;
        } else {
            let badgesHtml = '';
            if (data) {
                if (data.durationMs) badgesHtml += `<span class="badge bg-secondary">${data.durationMs}ms</span>`;
                if (data.anonymizedEntities > 0) badgesHtml += `<span class="badge bg-warning text-dark">${data.anonymizedEntities} anonymisiert</span>`;
                if (data.toolsUsed && data.toolsUsed.length > 0) {
                    const toolNames = data.toolsUsed.map(t => t.split(':')[1]).join(', ');
                    badgesHtml += `<span class="badge bg-primary">Tools: ${escapeHtml(toolNames)}</span>`;
                }
            }
            messageDiv.className = 'd-flex gap-2';
            messageDiv.innerHTML = `
                <div class="rounded-circle bg-light d-flex align-items-center justify-content-center flex-shrink-0" style="width:36px;height:36px;font-size:0.8rem;font-weight:600;">KI</div>
                <div>
                    <div class="bg-light border rounded p-2" style="white-space: pre-wrap; word-break: break-word;">${escapeHtml(content)}</div>
                    ${badgesHtml ? `<div class="d-flex flex-wrap gap-1 mt-1">${badgesHtml}</div>` : ''}
                </div>`;
        }

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>

</body>
</html>
